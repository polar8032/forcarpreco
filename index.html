<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Forçar Preço</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Reset e Base */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            background-color: #f0f2f5; 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            overflow: hidden; 
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Modal Backdrop Blur */
        .backdrop-blur-md { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Scale: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
            Box: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
            Share: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>,
            Help: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            Close: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path fillRule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clipRule="evenodd" /></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        };

        // --- HELP MODAL COMPONENT ---
        const HelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center animate-fade-in">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-white w-full max-w-md rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-2xl font-extrabold text-gray-800">Ajuda</h3>
                            <button onClick={onClose} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors"><Icons.Close /></button>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <h4 className="text-indigo-600 font-bold text-lg mb-2 flex items-center gap-2"><Icons.Box /> Modo Unitário</h4>
                                <ul className="space-y-3 pl-4 border-l-2 border-gray-100">
                                    <li className="text-sm text-gray-600"><strong className="text-gray-900">Está a passar a:</strong> Insere o preço final (incorreto) que está a passar na caixa.</li>
                                    <li className="text-sm text-gray-600"><strong className="text-gray-900">Desconto direto:</strong> Valor do desconto (em €) que o sistema está a aplicar.</li>
                                    <li className="text-sm text-gray-600"><strong className="text-gray-900">Quero que passe a:</strong> O preço final correto que pretendes que fique.</li>
                                    <li className="bg-green-50 text-green-700 p-2 rounded-r-lg border-l-4 border-green-500 text-sm font-bold">
                                        Colocar no POS: Valor que deves inserir no sistema ao forçar o preço.
                                    </li>
                                </ul>
                            </div>

                            <div>
                                <h4 className="text-indigo-600 font-bold text-lg mb-2 flex items-center gap-2"><Icons.Scale /> Modo Ao Peso (Kg)</h4>
                                <ul className="space-y-3 pl-4 border-l-2 border-gray-100">
                                    <li className="text-sm text-gray-600"><strong className="text-gray-900">Está a passar a:</strong> Preço por Kg (incorreto) que está a passar na caixa.</li>
                                    <li className="text-sm text-gray-600"><strong className="text-gray-900">Desconto direto:</strong> Valor do desconto (em €) que o sistema está a aplicar.</li>
                                    <li className="text-sm text-gray-600"><strong className="text-gray-900">Quero que passe a:</strong> Preço por Kg final correto que pretendes.</li>
                                    <li className="bg-green-50 text-green-700 p-2 rounded-r-lg border-l-4 border-green-500 text-sm font-bold">
                                        Colocar no POS: Valor base que deves inserir para atingir o preço final por Kg.
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <button onClick={onClose} className="w-full mt-8 bg-gray-900 text-white py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform">
                            Entendi, fechar
                        </button>
                    </div>
                </div>
            );
        };

        // --- PRICE ENGINEER COMPONENT ---
        const PriceEngineer = () => {
            const [tab, setTab] = useState('unit'); // 'unit' | 'weight'
            const [showHelp, setShowHelp] = useState(false);
            
            const [baseInput, setBaseInput] = useState('');
            const [discInput, setDiscInput] = useState(''); 
            const [targetInput, setTargetInput] = useState('');

            // Reset inputs on tab change
            useEffect(() => { 
                clearAll();
            }, [tab]);

            // Clear All Function
            const clearAll = () => {
                setBaseInput('');
                setDiscInput('');
                setTargetInput('');
            };

            // Share Functionality
            const handleShare = async () => {
                const shareData = {
                    title: 'Forçar Preço',
                    text: 'Calculadora rápida para acertos de preços e quebras.',
                    url: window.location.href
                };

                if (navigator.share) {
                    try {
                        await navigator.share(shareData);
                    } catch (err) {
                        console.log('Partilha cancelada');
                    }
                } else {
                    // Fallback para clipboard
                    const textArea = document.createElement("textarea");
                    textArea.value = window.location.href;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert("Link copiado para a área de transferência!");
                    } catch (err) {
                        alert("Não foi possível partilhar.");
                    }
                    document.body.removeChild(textArea);
                }
            };

            let bottomResult = null;
            let bottomLabel = "Colocar no POS (Base)";
            
            // Lógica Unificada: Engenharia Reversa
            const final = parseFloat(baseInput);
            const discEuro = parseFloat(discInput);
            
            let tagPct = '0%';

            if (final && !isNaN(discEuro)) {
                const base = final + discEuro;
                // Cálculo da Percentagem
                const pctVal = base > 0 ? (discEuro / base) : 0; 
                tagPct = `${(pctVal * 100).toFixed(2)}%`; 

                const target = parseFloat(targetInput);
                if (target) {
                    if (pctVal >= 1) {
                            bottomResult = "---";
                    } else {
                            const calculatedBase = target / (1 - pctVal);
                            bottomResult = calculatedBase.toFixed(2);
                    }
                }
            }

            return (
                <div className="h-full flex flex-col animate-fade-in overflow-y-auto pb-safe relative">
                    <HelpModal isOpen={showHelp} onClose={() => setShowHelp(false)} />

                    {/* HEADER CUSTOMIZADO COM ACTIONS */}
                    <div className="flex justify-between items-center mb-6 pt-2">
                         <div className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-indigo-200 shadow-lg font-mono tracking-tighter">
                                FP
                            </div>
                            <div>
                                <h1 className="text-xl font-extrabold text-gray-800 tracking-tight leading-none">Forçar Preço</h1>
                                <span className="text-[10px] font-bold text-indigo-600 uppercase tracking-widest bg-indigo-50 px-1.5 py-0.5 rounded">Calculadora</span>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={handleShare} className="bg-indigo-50 text-indigo-600 px-3 py-2 rounded-full text-xs font-bold flex items-center gap-1.5 hover:bg-indigo-100 transition-colors active:scale-95">
                                <Icons.Share /> <span>Partilhar app</span>
                            </button>
                            <button onClick={() => setShowHelp(true)} className="bg-gray-100 text-gray-600 w-9 h-9 rounded-full flex items-center justify-center font-bold hover:bg-gray-200 transition-colors active:scale-95">
                                <span className="text-lg">?</span>
                            </button>
                        </div>
                    </div>

                    {/* TABS HEADER */}
                    <div className="flex bg-white p-1 rounded-2xl mb-4 border border-gray-200 shadow-sm flex-none">
                        <button onClick={() => setTab('unit')} className={`flex-1 py-3 rounded-xl text-sm font-bold flex justify-center items-center gap-2 transition-all duration-200 ${tab === 'unit' ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
                            <Icons.Box /> Unitário
                        </button>
                        <button onClick={() => setTab('weight')} className={`flex-1 py-3 rounded-xl text-sm font-bold flex justify-center items-center gap-2 transition-all duration-200 ${tab === 'weight' ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
                            <Icons.Scale /> Ao Peso
                        </button>
                    </div>

                    {/* NOTA DE ATENÇÃO (Condicional) */}
                    <div className="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-xl animate-fade-in shadow-sm">
                        <div className="flex items-center gap-2 text-yellow-700 font-extrabold uppercase text-xs mb-1 tracking-wider">
                            <Icons.Alert /> Atenção
                        </div>
                        <p className="text-xs text-yellow-800/90 leading-relaxed font-medium">
                            {tab === 'unit' 
                                ? "Calcular apenas neste modo em produtos unitários quando está em vigor promoção diferente da que estava exposta para o cliente."
                                : "Calcular apenas neste modo em produtos ao peso quando está em vigor promoção diferente da que estava exposta para o cliente ou por algum motivo o preço passar mal apesar de estar correto em sistema."
                            }
                        </p>
                    </div>

                    {/* COMPUTER SCREEN CONTAINER */}
                    <div className="p-5 rounded-3xl shadow-xl mb-4 relative overflow-hidden flex-none transition-colors border-b-8 bg-gray-800 border-gray-600 text-green-400 font-mono">
                        
                        <div className="relative border-b border-gray-600 pb-2 mb-4 mt-1">
                            <div className="text-center">
                                <span className="text-xs font-bold uppercase tracking-widest text-gray-400">
                                    {tab === 'unit' ? 'Unitário' : 'Ao Peso'}
                                </span>
                            </div>
                            <button onClick={clearAll} className="absolute right-0 top-1/2 -translate-y-1/2 text-gray-500 hover:text-red-400 transition-colors p-1" title="Limpar tudo">
                                <Icons.Trash />
                            </button>
                        </div>

                        <div className="grid grid-cols-2 gap-4 items-end">
                            <div>
                                <label className="block text-sm font-bold uppercase mb-2 text-green-400 whitespace-nowrap overflow-hidden text-ellipsis">
                                    Está a passar <span className="text-yellow-400">{tab === 'weight' ? '(€/Kg)' : '(€)'}</span>
                                </label>
                                <input type="number" inputMode="decimal" value={baseInput} onChange={e => setBaseInput(e.target.value)} className="w-full border rounded-xl p-3 text-center font-bold text-xl outline-none transition-colors bg-gray-900 border-gray-600 text-green-400 focus:border-green-500 placeholder-gray-700" placeholder="0.00" />
                            </div>
                            <div>
                                <label className="block text-sm font-bold uppercase mb-2 text-green-400 whitespace-nowrap overflow-hidden text-ellipsis">
                                    Desconto Direto <span className="text-yellow-400">(€)</span>
                                </label>
                                <input type="number" inputMode="decimal" value={discInput} onChange={e => setDiscInput(e.target.value)} className="w-full border rounded-xl p-3 text-center font-bold text-xl outline-none transition-colors bg-gray-900 border-gray-600 text-green-400 focus:border-green-500 placeholder-gray-700" placeholder="0.00" />
                            </div>
                        </div>

                        <div className="mt-6 pt-4 border-t border-gray-700/50">
                            <label className="block text-sm font-bold uppercase mb-2 text-center tracking-wider text-green-400">Quero que passe a <span className="text-yellow-400">{tab === 'weight' ? '(€/Kg)' : '(€)'}</span></label>
                            <input type="number" inputMode="decimal" value={targetInput} onChange={e => setTargetInput(e.target.value)} className="w-full border-2 rounded-2xl p-4 text-center font-bold text-3xl outline-none transition-all shadow-lg shadow-black/20 bg-gray-900 border-green-500/50 text-green-400 focus:border-green-400 focus:bg-gray-800 placeholder-gray-700" placeholder="0.00" />
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl shadow-sm border border-gray-200 p-6 flex flex-col justify-center mb-6 flex-none">
                        <div className="text-center">
                            <p className="text-xs font-bold uppercase tracking-wider text-gray-400 mb-3">{bottomLabel}</p>
                            <div className="text-5xl font-bold font-mono text-gray-800 tracking-tighter">{bottomResult ? `€${bottomResult}` : '---'}</div>
                            {bottomResult && (
                                <div className="text-xs inline-block px-3 py-1 rounded-full mt-2 font-medium bg-green-50 text-green-700 border border-green-100">
                                    Preço Base Calculado
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Copyright Footer */}
                    <div className="mt-auto py-6 text-center">
                        <p className="text-xs font-bold text-gray-400 opacity-60">Copyright Ricardo Salas</p>
                    </div>
                </div>
            );
        };

        const App = () => {
            return (
                <div className="w-full h-[100dvh] bg-gray-50 relative flex flex-col overflow-hidden max-w-md mx-auto shadow-2xl">
                    <main className="flex-1 overflow-hidden p-5 bg-[#f5f7fa]">
                        <PriceEngineer />
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
