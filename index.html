<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Forçar Preço</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        html, body { 
            height: 100%; margin: 0; padding: 0; 
            background-color: #f0f2f5; 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; overflow: hidden; 
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .backdrop-blur-md { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        input:focus { outline: none; }
        
        /* Ocultar scrollbar na calculadora */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <div id="app" class="w-full h-[100dvh] bg-gray-50 relative flex flex-col overflow-hidden max-w-md mx-auto shadow-2xl">
        
        <main class="flex-1 overflow-y-auto p-5 bg-[#f5f7fa] w-full pb-20 pt-safe relative">
            
            <div class="flex justify-between items-center mb-6 pt-2">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-indigo-200 shadow-lg font-mono tracking-tighter">
                        FP
                    </div>
                    <div>
                        <h1 class="text-xl font-extrabold text-gray-800 tracking-tight leading-none">Forçar Preço</h1>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button @click="mostrarCalculadora = true" class="bg-indigo-50 text-indigo-600 w-9 h-9 rounded-full flex items-center justify-center font-bold hover:bg-indigo-100 transition-colors active:scale-95" title="Abrir Calculadora">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
                    </button>

                    <button @click="partilhar" class="bg-indigo-50 text-indigo-600 px-3 py-2 rounded-full text-xs font-bold flex items-center gap-1.5 hover:bg-indigo-100 transition-colors active:scale-95">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                        <span>Partilhar</span>
                    </button>
                    <button @click="mostrarAjuda = true" class="bg-gray-100 text-gray-600 w-9 h-9 rounded-full flex items-center justify-center font-bold hover:bg-gray-200 transition-colors active:scale-95">
                        <span class="text-lg">?</span>
                    </button>
                </div>
            </div>

            <div class="flex bg-white p-1 rounded-2xl mb-4 border border-gray-200 shadow-sm flex-none">
                <button @click="mudarTab('unit')" 
                        :class="['flex-1 py-3 rounded-xl text-sm font-bold flex justify-center items-center gap-2 transition-all duration-200', 
                                 tab === 'unit' ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-400 hover:bg-gray-50']">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                    Unitário
                </button>
                <button @click="mudarTab('weight')" 
                        :class="['flex-1 py-3 rounded-xl text-sm font-bold flex justify-center items-center gap-2 transition-all duration-200', 
                                 tab === 'weight' ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-400 hover:bg-gray-50']">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>
                    Ao Peso
                </button>
            </div>

            <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-xl animate-fade-in shadow-sm">
                <div class="flex items-center gap-2 text-yellow-700 font-extrabold uppercase text-xs mb-1 tracking-wider">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>
                    Atenção
                </div>
                <p class="text-xs text-yellow-800/90 leading-relaxed font-medium">
                    {{ textoAtencao }}
                </p>
            </div>

            <div class="p-5 rounded-3xl shadow-xl mb-4 relative overflow-hidden flex-none transition-colors border-b-8 bg-gray-800 border-gray-600 text-green-400 font-mono">
                <div class="relative border-b border-gray-600 pb-2 mb-4 mt-1">
                    <div class="text-center">
                        <span class="text-xs font-bold uppercase tracking-widest text-gray-400">
                            {{ tab === 'unit' ? 'Unitário' : 'Ao Peso' }}
                        </span>
                    </div>
                    <button @click="limparTudo" class="absolute right-0 top-1/2 -translate-y-1/2 text-gray-500 hover:text-red-400 transition-colors p-1" title="Limpar tudo">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-bold uppercase mb-2 text-green-400 leading-tight">
                            Está a passar a <span class="text-yellow-400">{{ tab === 'weight' ? '(€/Kg)' : '(€)' }}</span>
                        </label>
                        <input type="text" inputmode="decimal" v-model="baseInput" @input="formatarInput('baseInput')" class="w-full border rounded-xl p-3 text-center font-bold text-lg outline-none transition-colors bg-gray-900 border-gray-600 text-green-400 focus:border-green-500 placeholder-gray-700" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-bold uppercase mb-2 text-green-400 leading-tight">
                            Desconto Direto que está a passar <span class="text-yellow-400">(€)</span>
                        </label>
                        <input type="text" inputmode="decimal" v-model="discInput" @input="formatarInput('discInput')" class="w-full border rounded-xl p-3 text-center font-bold text-lg outline-none transition-colors bg-gray-900 border-gray-600 text-green-400 focus:border-green-500 placeholder-gray-700" placeholder="0.00">
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-700/50">
                    <label class="block text-sm font-bold uppercase mb-2 text-center tracking-wider text-green-400">
                        Quero que passe a <span class="text-yellow-400">{{ tab === 'weight' ? '(€/Kg)' : '(€)' }}</span>
                    </label>
                    <input type="text" inputmode="decimal" v-model="targetInput" @input="formatarInput('targetInput')" class="w-full border-2 rounded-2xl p-4 text-center font-bold text-3xl outline-none transition-all shadow-lg shadow-black/20 bg-gray-900 border-green-500/50 text-green-400 focus:border-green-400 focus:bg-gray-800 placeholder-gray-700" placeholder="0.00">
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-gray-200 p-6 flex flex-col justify-center mb-6 flex-none">
                <div class="text-center">
                    <p class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-3">Colocar no POS</p>
                    <div class="text-5xl font-bold font-mono text-gray-800 tracking-tighter">
                        {{ resultadoFinal }}
                    </div>
                    <div v-if="resultadoFinal !== '---'" class="text-xs inline-block px-3 py-1 rounded-full mt-2 font-medium bg-green-50 text-green-700 border border-green-100">
                        Preço Base Calculado
                    </div>
                </div>
            </div>
            
            <div class="mt-auto py-6 text-center">
                <p class="text-xs font-bold text-gray-400 opacity-60">Copyright Ricardo Salas</p>
            </div>

            <div v-if="mostrarAjuda" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center animate-fade-in">
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="mostrarAjuda = false"></div>
                <div class="relative bg-white w-full max-w-md rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-extrabold text-gray-800">Ajuda</h3>
                        <button @click="mostrarAjuda = false" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <h4 class="text-indigo-600 font-bold text-lg mb-2 flex items-center gap-2">Modo Unitário</h4>
                            <ul class="space-y-3 pl-4 border-l-2 border-gray-100 text-sm text-gray-600">
                                <li><strong class="text-gray-900">Está a passar a:</strong> Insere o preço final (incorreto) que está a passar na caixa.</li>
                                <li><strong class="text-gray-900">Desconto direto:</strong> Valor do desconto (em €) que o sistema está a aplicar.</li>
                                <li><strong class="text-gray-900">Quero que passe a:</strong> O preço final correto que pretendes que fique.</li>
                                <li class="bg-green-50 text-green-700 p-2 rounded-r-lg border-l-4 border-green-500 font-bold">
                                    Colocar no POS: Valor que deves inserir no sistema ao forçar o preço.
                                </li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="text-indigo-600 font-bold text-lg mb-2 flex items-center gap-2">Modo Ao Peso (Kg)</h4>
                            <ul class="space-y-3 pl-4 border-l-2 border-gray-100 text-sm text-gray-600">
                                <li><strong class="text-gray-900">Está a passar a:</strong> Preço por Kg (incorreto) que está a passar na caixa.</li>
                                <li><strong class="text-gray-900">Desconto direto:</strong> Valor do desconto (em €) que o sistema está a aplicar.</li>
                                <li><strong class="text-gray-900">Quero que passe a:</strong> Preço por Kg final correto que pretendes.</li>
                                <li class="bg-green-50 text-green-700 p-2 rounded-r-lg border-l-4 border-green-500 font-bold">
                                    Colocar no POS: Valor base que deves inserir para atingir o preço final por Kg.
                                </li>
                            </ul>
                        </div>
                    </div>

                    <button @click="mostrarAjuda = false" class="w-full mt-8 bg-gray-900 text-white py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform">
                        Entendi, fechar
                    </button>
                </div>
            </div>

            <div v-if="mostrarCalculadora" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center animate-fade-in">
                <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="mostrarCalculadora = false"></div>
                
                <div class="relative bg-gray-900 w-full max-w-sm rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up border border-gray-700 flex flex-col max-h-[90dvh]">
                    
                    <div class="bg-black/60 rounded-xl p-4 mb-4 text-right border border-gray-700 flex-none">
                        <div class="text-sm text-gray-400 h-6 font-medium overflow-hidden text-ellipsis whitespace-nowrap">
                            {{ calcExpressaoCompleta || '&nbsp;' }}
                        </div>
                        <div class="text-4xl font-mono font-bold text-white tracking-wider overflow-x-auto scrollbar-hide whitespace-nowrap">
                            {{ calcDisplay }}
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-3 flex-none mb-4">
                        <button @click="calcLimpar" class="col-span-2 bg-gray-700 text-red-400 font-bold p-3 sm:p-4 rounded-xl active:bg-gray-600 text-lg">AC</button>
                        <button @click="calcPercentagem" class="bg-gray-700 text-cyan-400 font-bold p-3 sm:p-4 rounded-xl active:bg-gray-600 text-lg">%</button>
                        <button @click="calcOperacao('/')" class="bg-indigo-600 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-indigo-500 text-xl">÷</button>
                        
                        <button @click="calcNumero('7')" class="bg-gray-800 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-gray-700 text-xl">7</button>
                        <button @click="calcNumero('8')" class="bg-gray-800 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-gray-700 text-xl">8</button>
                        <button @click="calcNumero('9')" class="bg-gray-800 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-gray-700 text-xl">9</button>
                        <button @click="calcOperacao('*')" class="bg-indigo-600 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-indigo-500 text-xl">×</button>
                        
                        <button @click="calcNumero('4')" class="bg-gray-800 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-gray-700 text-xl">4</button>
                        <button @click="calcNumero('5')" class="bg-gray-800 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-gray-700 text-xl">5</button>
                        <button @click="calcNumero('6')" class="bg-gray-800 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-gray-700 text-xl">6</button>
                        <button @click="calcOperacao('-')" class="bg-indigo-600 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-indigo-500 text-xl">−</button>
                        
                        <button @click="calcNumero('1')" class="bg-gray-800 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-gray-700 text-xl">1</button>
                        <button @click="calcNumero('2')" class="bg-gray-800 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-gray-700 text-xl">2</button>
                        <button @click="calcNumero('3')" class="bg-gray-800 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-gray-700 text-xl">3</button>
                        <button @click="calcOperacao('+')" class="bg-indigo-600 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-indigo-500 text-xl">+</button>
                        
                        <button @click="calcNumero('0')" class="col-span-2 bg-gray-800 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-gray-700 text-xl">0</button>
                        <button @click="calcPonto" class="bg-gray-800 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-gray-700 text-xl">.</button>
                        <button @click="calcResultado" class="bg-green-500 text-white font-bold p-3 sm:p-4 rounded-xl active:bg-green-600 shadow-lg shadow-green-500/20 text-xl">=</button>
                    </div>

                    <div class="flex flex-col border-t border-gray-700 pt-2 transition-all duration-300 ease-in-out"
                         :class="mostrarHistorico ? 'flex-1 min-h-[150px] overflow-hidden' : 'flex-none'">
                        
                        <div class="flex justify-between items-center mb-1 px-2 py-3 cursor-pointer hover:bg-gray-800/50 rounded-lg select-none" 
                             @click="mostrarHistorico = !mostrarHistorico">
                            
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 text-xs transition-transform duration-300" 
                                      :class="{'rotate-180': mostrarHistorico}">▼</span>
                                
                                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    {{ mostrarHistorico ? 'Ocultar Histórico' : 'Ver Histórico' }}
                                </span>
                                
                                <span v-if="calcHistorico.length > 0" class="bg-gray-700 text-white text-[10px] px-1.5 py-0.5 rounded-full font-mono">
                                    {{ calcHistorico.length }}
                                </span>
                            </div>

                            <button v-if="mostrarHistorico && calcHistorico.length > 0" 
                                    @click.stop="calcLimparHistorico" 
                                    class="text-xs text-red-400 hover:text-red-300 flex items-center gap-1 bg-gray-800 px-2 py-1 rounded border border-gray-700 hover:border-red-400/50 transition-colors">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                Limpar
                            </button>
                        </div>
                        
                        <div v-if="mostrarHistorico" class="overflow-y-auto pr-1 space-y-2 flex-1 scrollbar-hide animate-fade-in p-1">
                            <div v-if="calcHistorico.length === 0" class="text-center text-gray-600 text-xs py-4 italic">
                                O histórico está vazio.
                            </div>
                            <div v-for="(item, index) in calcHistorico" :key="index" class="bg-gray-800/50 rounded-lg p-3 border border-gray-700/50 flex justify-between items-center hover:bg-gray-800 transition-colors">
                                <span class="text-gray-400 text-sm font-mono">{{ item.conta }} =</span>
                                <span class="text-white font-bold font-mono text-lg">{{ item.resultado }}</span>
                            </div>
                        </div>
                    </div>

                    <button @click="mostrarCalculadora = false" class="w-full mt-2 text-gray-500 text-sm font-medium py-2 hover:text-white transition-colors">
                        Fechar
                    </button>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Estado da App Principal
                    tab: 'unit',
                    mostrarAjuda: false,
                    baseInput: '',
                    discInput: '',
                    targetInput: '',

                    // Estado da Calculadora
                    mostrarCalculadora: false,
		    mostrarHistorico: false,
                    calcDisplay: '0',
                    calcExpressao: '', 
                    calcValorAnterior: null,
                    calcOperador: null,
                    calcReiniciarProximo: false,
                    calcHistorico: [] // <--- NOVO: Lista de histórico
                }
            },
            computed: {
                textoAtencao() {
                    return this.tab === 'unit' 
                        ? "Calcular apenas neste modo em produtos unitários quando está em vigor promoção diferente da que estava exposta para o cliente."
                        : "Calcular apenas neste modo em produtos ao peso quando está em vigor promoção diferente da que estava exposta para o cliente ou por algum motivo o preço passar mal."
                },
                resultadoFinal() {
                    const final = parseFloat(this.baseInput);
                    const discEuro = parseFloat(this.discInput);
                    const target = parseFloat(this.targetInput);
                    if (!final || isNaN(discEuro) || !target) return '---';
                    const base = final + discEuro;
                    const pctVal = base > 0 ? (discEuro / base) : 0;
                    if (pctVal >= 1) return '---';
                    const calculatedBase = target / (1 - pctVal);
                    return '€' + calculatedBase.toFixed(2);
                },
                // NOVO: Computada para mostrar a expressão completa em tempo real
                calcExpressaoCompleta() {
                    if (this.calcOperador && !this.calcReiniciarProximo) {
                        // Se estiver a escrever o segundo número, mostra "10 + 5"
                        const simbolos = { '+': '+', '-': '-', '*': '×', '/': '÷' };
                        return `${this.calcValorAnterior} ${simbolos[this.calcOperador]} ${this.calcDisplay}`;
                    }
                    // Se não, mostra só o histórico da operação (ex: "10 +")
                    return this.calcExpressao;
                }
            },
            methods: {
                mudarTab(novaTab) { this.tab = novaTab; this.limparTudo(); },
                limparTudo() { this.baseInput = ''; this.discInput = ''; this.targetInput = ''; },
                formatarInput(campo) { this[campo] = this[campo].replace(',', '.'); },
                async partilhar() { /* ... código de partilha igual ... */ 
                     const data = { title: 'Forçar Preço', text: 'Calculadora rápida.', url: window.location.href };
                     if (navigator.share) { try { await navigator.share(data); } catch (err) {} }
                     else { alert("Link copiado!"); } // Simplificado para brevidade
                },

                // --- MÉTODOS CALCULADORA ATUALIZADOS ---
                calcNumero(n) {
                    if (this.calcDisplay === '0' || this.calcReiniciarProximo) {
                        this.calcDisplay = n;
                        this.calcReiniciarProximo = false;
                    } else {
                        // AUMENTADO PARA 20 DÍGITOS
                        if (this.calcDisplay.length < 20) {
                            this.calcDisplay += n;
                        }
                    }
                },
                calcPonto() {
                    if (this.calcReiniciarProximo) {
                        this.calcDisplay = '0.';
                        this.calcReiniciarProximo = false;
                    } else if (!this.calcDisplay.includes('.')) {
                        this.calcDisplay += '.';
                    }
                },
                calcLimpar() {
                    this.calcDisplay = '0';
                    this.calcValorAnterior = null;
                    this.calcOperador = null;
                    this.calcExpressao = '';
                    this.calcReiniciarProximo = false;
                },
                calcLimparHistorico() {
                    this.calcHistorico = [];
                },
                calcOperacao(op) {
                    if (this.calcOperador !== null && !this.calcReiniciarProximo) {
                        this.calcResultado();
                    }
                    this.calcValorAnterior = parseFloat(this.calcDisplay);
                    this.calcOperador = op;
                    const simbolos = { '+': '+', '-': '-', '*': '×', '/': '÷' };
                    this.calcExpressao = `${this.calcDisplay} ${simbolos[op]}`;
                    this.calcReiniciarProximo = true;
                },
                calcPercentagem() {
                    if (!this.calcDisplay) return;
                    const atual = parseFloat(this.calcDisplay);
                    
                    if ((this.calcOperador === '+' || this.calcOperador === '-') && this.calcValorAnterior !== null) {
                        const percentagem = (this.calcValorAnterior * atual) / 100;
                        this.calcDisplay = String(parseFloat(percentagem.toPrecision(10)));
                        const simbolos = { '+': '+', '-': '-', '*': '×', '/': '÷' };
                        // Mostra "100 - 20%" no visor pequeno
                        this.calcExpressao = `${this.calcValorAnterior} ${simbolos[this.calcOperador]} ${atual}%`;
                    } else {
                        this.calcDisplay = String(atual / 100);
                        if(this.calcOperador) {
                             const simbolos = { '+': '+', '-': '-', '*': '×', '/': '÷' };
                             this.calcExpressao = `${this.calcValorAnterior} ${simbolos[this.calcOperador]} ${atual}%`;
                        }
                    }
                },
                calcResultado() {
                    if (this.calcOperador === null || this.calcReiniciarProximo) return;

                    const atual = parseFloat(this.calcDisplay);
                    const anterior = this.calcValorAnterior;
                    let resultado = 0;
                    const simbolos = { '+': '+', '-': '-', '*': '×', '/': '÷' };
                    const operadorVisual = simbolos[this.calcOperador];

                    switch (this.calcOperador) {
                        case '+': resultado = anterior + atual; break;
                        case '-': resultado = anterior - atual; break;
                        case '*': resultado = anterior * atual; break;
                        case '/': 
                            if (atual === 0) {
                                this.calcDisplay = 'Erro';
                                this.calcReiniciarProximo = true;
                                return;
                            }
                            resultado = anterior / atual; 
                            break;
                    }

                    resultado = Math.round(resultado * 100000) / 100000;

                    // ADICIONAR AO HISTÓRICO
                    // Se foi percentagem, o display pequeno já tem o "%", senão montamos a conta normal
                    let contaTexto = this.calcExpressao.includes('%') 
                        ? this.calcExpressao 
                        : `${anterior} ${operadorVisual} ${atual}`;

                    this.calcHistorico.unshift({
                        conta: contaTexto,
                        resultado: resultado
                    });

                    // Limita histórico a 50 itens para não pesar
                    if(this.calcHistorico.length > 50) this.calcHistorico.pop();

                    this.calcDisplay = String(resultado);
                    this.calcExpressao = ''; 
                    this.calcOperador = null;
                    this.calcReiniciarProximo = true;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
